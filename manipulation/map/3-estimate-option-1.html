<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<title>processing file: 3-estimate-option-1.Rmd</title>

<script type="text/javascript">
window.onload = function() {
  var imgs = document.getElementsByTagName('img'), i, img;
  for (i = 0; i < imgs.length; i++) {
    img = imgs[i];
    // center an image if it is the only element of its parent
    if (img.parentElement.childElementCount === 1)
      img.parentElement.style.textAlign = 'center';
  }
};
</script>





<style type="text/css">
body, td {
   font-family: sans-serif;
   background-color: white;
   font-size: 13px;
}

body {
  max-width: 800px;
  margin: auto;
  padding: 1em;
  line-height: 20px;
}

tt, code, pre {
   font-family: 'DejaVu Sans Mono', 'Droid Sans Mono', 'Lucida Console', Consolas, Monaco, monospace;
}

h1 {
   font-size:2.2em;
}

h2 {
   font-size:1.8em;
}

h3 {
   font-size:1.4em;
}

h4 {
   font-size:1.0em;
}

h5 {
   font-size:0.9em;
}

h6 {
   font-size:0.8em;
}

a:visited {
   color: rgb(50%, 0%, 50%);
}

pre, img {
  max-width: 100%;
}
pre {
  overflow-x: auto;
}
pre code {
   display: block; padding: 0.5em;
}

code {
  font-size: 92%;
  border: 1px solid #ccc;
}

code[class] {
  background-color: #F8F8F8;
}

table, td, th {
  border: none;
}

blockquote {
   color:#666666;
   margin:0;
   padding-left: 1em;
   border-left: 0.5em #EEE solid;
}

hr {
   height: 0px;
   border-bottom: none;
   border-top-width: thin;
   border-top-style: dotted;
   border-top-color: #999999;
}

@media print {
   * {
      background: transparent !important;
      color: black !important;
      filter:none !important;
      -ms-filter: none !important;
   }

   body {
      font-size:12pt;
      max-width:100%;
   }

   a, a:visited {
      text-decoration: underline;
   }

   hr {
      visibility: hidden;
      page-break-before: always;
   }

   pre, blockquote {
      padding-right: 1em;
      page-break-inside: avoid;
   }

   tr, img {
      page-break-inside: avoid;
   }

   img {
      max-width: 100% !important;
   }

   @page :left {
      margin: 15mm 20mm 15mm 10mm;
   }

   @page :right {
      margin: 15mm 10mm 15mm 20mm;
   }

   p, h2, h3 {
      orphans: 3; widows: 3;
   }

   h2, h3 {
      page-break-after: avoid;
   }
}
</style>



</head>

<body>
<p>This report was automatically generated with the R package <strong>knitr</strong>
(version 1.14).</p>

<p>knitr::stitch_rmd(script=&ldquo;./manipulation/map/3-estimate-option-1.R&rdquo;, output=&ldquo;./manipulation/map/3-estimate-option-1.md&rdquo;)## </p>

<h2>processing file: 3-estimate-option-1.Rmd</h2>

<h2>Error in parse_block(g[-1], g[1], params.src): duplicate label &#39;load-rerequisites&#39;</h2>

<p>#These first few lines run only when the file is run in RStudio, !!NOT when an Rmd/Rnw file calls it!!# rm(list=ls(all=TRUE))  #Clear the variables from previous runs.
base::source(&ldquo;./manipulation/map/2-prepare-for-estimation.R&rdquo;) # load  ELECT functions## Before ms encoding: </p>

<h2>id   age_bl  male edu age_at_visit mmse age_death</h2>

<h2>7589 75507759 77.51403 FALSE   8     77.51403   30        NA</h2>

<h2>7590 75507759 77.51403 FALSE   8     78.86927   -1        NA</h2>

<h2>7591 75507759 77.51403 FALSE   8     79.75086   30        NA</h2>

<h2>7592 75507759 77.51403 FALSE   8     80.25188   29        NA</h2>

<h2>7593 75507759 77.51403 FALSE   8     81.42094   29        NA</h2>

<h2>7594 75507759 77.51403 FALSE   8     82.66393   -2        NA</h2>

<h2>7595 75507759 77.51403 FALSE   8     83.54552   -2        NA</h2>

<h2>presumed_alive</h2>

<h2>7589           TRUE</h2>

<h2>7590           TRUE</h2>

<h2>7591           TRUE</h2>

<h2>7592           TRUE</h2>

<h2>7593           TRUE</h2>

<h2>7594           TRUE</h2>

<h2>7595           TRUE</h2>

<h2>After ms encoding</h2>

<h2>id   age_bl  male edu      age state presumed_alive</h2>

<h2>7589 75507759 77.51403 FALSE   8 77.51403     1           TRUE</h2>

<h2>7590 75507759 77.51403 FALSE   8 78.86927    -1           TRUE</h2>

<h2>7591 75507759 77.51403 FALSE   8 79.75086     1           TRUE</h2>

<h2>7592 75507759 77.51403 FALSE   8 80.25188     1           TRUE</h2>

<h2>7593 75507759 77.51403 FALSE   8 81.42094     1           TRUE</h2>

<h2>7594 75507759 77.51403 FALSE   8 82.66393    -2           TRUE</h2>

<h2>7595 75507759 77.51403 FALSE   8 83.54552    -2           TRUE</h2>

<h2>First observation indicator is added.</h2>

<h2>id   age_bl  male edu      age state presumed_alive educat   educatF</h2>

<h2>1  9121 79.96988 FALSE  12 79.96988     1           TRUE      1 &gt;11 years</h2>

<h2>2  9121 79.96988 FALSE  12 81.08145     1           TRUE      1 &gt;11 years</h2>

<h2>3  9121 79.96988 FALSE  12 81.61259     1           TRUE      1 &gt;11 years</h2>

<h2>4  9121 79.96988 FALSE  12 82.59548     1           TRUE      1 &gt;11 years</h2>

<h2>5  9121 79.96988 FALSE  12 83.62218     1           TRUE      1 &gt;11 years</h2>

<h2>6 33027 81.00753 FALSE  14 81.00753     1           TRUE      1 &gt;11 years</h2>

<h2>firstobs</h2>

<h2>1        1</h2>

<h2>2        0</h2>

<h2>3        0</h2>

<h2>4        0</h2>

<h2>5        0</h2>

<h2>6        1</h2>

<h2>Subject count</h2>

<h2>unique_ids</h2>

<h2>1       1576</h2>

<h2>Frequency of states</h2>

<h2># A tibble: 6 Ã— 3</h2>

<h2>state count   pct</h2>

<h2><dbl> <int> <dbl></h2>

<h2>1    -2    78  0.01</h2>

<h2>2    -1   142  0.01</h2>

<h2>3     1  6629  0.65</h2>

<h2>4     2  1584  0.15</h2>

<h2>5     3  1155  0.11</h2>

<h2>6     4   680  0.07</h2>

<h2>State table:</h2>

<h2>to</h2>

<h2>from   -2   -1    1    2    3    4</h2>

<h2>-2   32    0    0    0    0    0</h2>

<h2>-1    0   25   27   13   27   50</h2>

<h2>1    32   59 4855  715  120  251</h2>

<h2>2     8   20  534  478  257  146</h2>

<h2>3     6   34   24   97  649  233</h2>

<p>cat(&ldquo;\n Save fitted models here:&rdquo;)## </p>

<h2>Save fitted models here:</h2>

<p>pathSaveFolder &lt;- &ldquo;./data/shared/derived/models/option-1/&rdquo;
estimate<em>multistate &lt;- function(
  model_name 
  ,ds                   # data object 
  ,Q                    # Q-matrix of transitions
  ,E                    # misspecification matrix
  ,qnames               # names of the rows in the Q matrix
  ,cov_names            # string with covariate names
){
  covariates</em> &lt;- as.formula(paste0(&ldquo;~&rdquo;,cov<em>names))
  # model &lt;- msm(
  #   formula       = state ~ age, 
  #   subject       = id, 
  #   data          = ds, 
  #   center        = FALSE,
  #   qmatrix       = Q, 
  #   ematrix       = E,
  #   death         = TRUE, 
  #   covariates    = covariates</em>,
  #   censor        = c(-1,-2), 
  #   censor.states = list(c(1,2,3), c(1,2,3)), 
  #   method        = method<em>,
  #   constraint    = constraint</em>,
  #   fixedpars     = fixedpars<em>,
  #   initprobs     = initprobs</em>,# c(.67,.16,.11,.07), # initprobs_
  #   est.initprobs = TRUE,
  #   control       = list(trace=0,REPORT=1,maxit=1000,fnscale=10000)
  # )
  model &lt;- paste0(&ldquo;test&rdquo;, covariates_)
  saveRDS(model, paste0(pathSaveFolder,model_name,&ldquo;.rds&rdquo;))
  return(model)
} </p>

<h1>transition matrixQ &lt;- rbind( c(0, q, 0, q),</h1>

<pre><code>        c(q, 0, q, q),
        c(0, 0, 0, q), 
        c(0, 0, 0, 0)) # misclassification matrixE &lt;- rbind( c( 0,  0,  0, 0),  
        c( 0,  0, .1, 0), 
        c( 0,  0,  0, 0),
        c( 0,  0,  0, 0) )# transition namesqnames = c(
</code></pre>

<p>&ldquo;Healthy - Mild&rdquo;,  # q12
  # &ldquo;Healthy - Severe&rdquo;, # q13
  &ldquo;Healthy - Dead&rdquo;,  # q14
  &ldquo;Mild - Healthy&rdquo;,  # q21<br/>
  &ldquo;Mild - Severe&rdquo;,   # q23
  &ldquo;Mild - Dead&rdquo;,     # q24
  # &ldquo;Severe - Healthy&rdquo;,# q31
  # &ldquo;Severe - Mild&rdquo;,   # q32
  &ldquo;Severe - Dead&rdquo;    # q34
)</p>

<h1>set estimation options that would be common for all modelsdigits = 2method_  = &ldquo;BFGS&rdquo;     # alternatively, if does not converge &ldquo;Nedler-Mead&rdquo; constraint_ = NULL    # additional model constraintsfixedpars_ = NULL     # fixed parametersinitprobs_ = initial_probabilities</h1>

<h1>compile model objects with msm() callestimate_multistate(&ldquo;mA1&rdquo;, ds, Q, E, qnames,cov_names = &ldquo;age&rdquo;)## [1] &ldquo;test~&rdquo;   &ldquo;testage&rdquo;</h1>

<p>estimate_multistate(&ldquo;mA2&rdquo;, ds, Q, E, qnames,cov_names = &ldquo;age + age_bl&rdquo;)## [1] &ldquo;test~&rdquo;            &ldquo;testage + age_bl&rdquo;
estimate_multistate(&ldquo;mA3&rdquo;, ds, Q, E, qnames,cov_names = &ldquo;age + age_bl + male&rdquo;)## [1] &ldquo;test~&rdquo;                   &ldquo;testage + age_bl + male&rdquo;
estimate_multistate(&ldquo;mA4&rdquo;, ds, Q, E, qnames,cov_names = &ldquo;age + age_bl + male + educat&rdquo;)## [1] &ldquo;test~&rdquo;                            &ldquo;testage + age_bl + male + educat&rdquo;
estimate_multistate(&ldquo;mA5&rdquo;, ds, Q, E, qnames,cov_names = &ldquo;age + age_bl + male + edu&rdquo;)## [1] &ldquo;test~&rdquo;                         &ldquo;testage + age_bl + male + edu&rdquo;</p>

<p>alive<em>states &lt;- c(1,2,3)ds_alive &lt;- ds[ds$state %in% alive_states,]age_min &lt;- 0age_max &lt;- 30age_bl &lt;- 0male &lt;- 0edu &lt;- 0replication_n &lt;- 100time_scale &lt;- &ldquo;years&quot;grid_par &lt;- .5
models &lt;- list()models[[&quot;msm&rdquo;]][[&ldquo;age&rdquo;]]    &lt;- readRDS(paste0(pathSaveFolder,&#39;mA1.rds&#39;))models[[&ldquo;msm&rdquo;]][[&ldquo;age_bl&rdquo;]] &lt;- readRDS(paste0(pathSaveFolder,&#39;mA2.rds&#39;))models[[&ldquo;msm&rdquo;]][[&ldquo;male&rdquo;]]   &lt;- readRDS(paste0(pathSaveFolder,&#39;mA3.rds&#39;))models[[&ldquo;msm&rdquo;]][[&ldquo;educat&rdquo;]] &lt;- readRDS(paste0(pathSaveFolder,&#39;mA4.rds&#39;))models[[&ldquo;msm&rdquo;]][[&ldquo;edu&rdquo;]]    &lt;- readRDS(paste0(pathSaveFolder,&#39;mA5.rds&#39;))for(model</em> in names(models)){
  # determine covariate list
  if(model<em>==&ldquo;age&rdquo;){covar_list    = list(age=age_min)}
  if(model</em>==&ldquo;age<em>bl&rdquo;){covar_list = list(age=age_min, age_bl=age_bl)}
  if(model</em>==&ldquo;male&rdquo;){covar<em>list   = list(age=age_min, age_bl=age_bl, male=male)}
  if(model</em>==&ldquo;educat&rdquo;){covar<em>list = list(age=age_min, age_bl=age_bl, male=male, educat=educat)}
  if(model</em>==&ldquo;edu&rdquo;){covar<em>list    = list(age=age_min, age_bl=age_bl, male=male, edu=edu)}
  # compute LE
  models[[model</em>]][[&ldquo;LE&rdquo;]] &lt;- elect(
    model          = models[[&ldquo;msm&rdquo;]][[model<em>]], # fitted msm model
    b.covariates   = covar_list, # list with specified covarites values
    statedistdata  = ds_alive, # data for distribution of living states
    time.scale.msm = time_scale, # time scale in multi-state model (&ldquo;years&rdquo;, &hellip;)
    h              = grid_par, # grid parameter for integration
    age.max        = age_max, # assumed maximum age in years
    S              = replication_n # number of simulation cycles
  )
  # models[[model</em>]][[&ldquo;LE&rdquo;]] &lt;- models[[&ldquo;msm&rdquo;]][[model_]] 
}## Error in if (model$center == TRUE) {: argument is of length zero</p>

<h1>save models estimated by elect() in a external object for faster access in the future saveRDS(models, paste0(pathSaveFolder,&ldquo;models.rds&rdquo;)) models &lt;- readRDS(paste0(pathSaveFolder,&ldquo;models.rds&rdquo;))lapply(models, names)## $msm</h1>

<h2>[1] &ldquo;age&rdquo;    &ldquo;age_bl&rdquo; &ldquo;male&rdquo;   &ldquo;educat&rdquo; &ldquo;edu&rdquo;</h2>

<p>The R session information (including the OS info, R version and all
packages used):</p>

<p>sessionInfo()## R version 3.3.1 (2016-06-21)</p>

<h2>Platform: x86_64-w64-mingw32/x64 (64-bit)</h2>

<h2>Running under: Windows &gt;= 8 x64 (build 9200)</h2>

<h2>locale:</h2>

<h2>[1] LC_COLLATE=English_United States.1252</h2>

<h2>[2] LC_CTYPE=English_United States.1252</h2>

<h2>[3] LC_MONETARY=English_United States.1252</h2>

<h2>[4] LC_NUMERIC=C</h2>

<h2>[5] LC_TIME=English_United States.1252</h2>

<h2>attached base packages:</h2>

<h2>[1] stats     graphics  grDevices utils     datasets  methods   base</h2>

<h2>other attached packages:</h2>

<h2>[1] magrittr_1.5 nnet_7.3-12  msm_1.6.1</h2>

<h2>loaded via a namespace (and not attached):</h2>

<h2>[1] Rcpp_0.12.6        knitr_1.14         splines_3.3.1</h2>

<h2>[4] MASS_7.3-45        munsell_0.4.3      testit_0.5</h2>

<h2>[7] colorspace_1.2-6   lattice_0.20-33    R6_2.1.3</h2>

<h2>[10] minqa_1.2.4        stringr_1.1.0      car_2.1-3</h2>

<h2>[13] plyr_1.8.4         dplyr_0.5.0        tools_3.3.1</h2>

<h2>[16] parallel_3.3.1     pbkrtest_0.4-6     grid_3.3.1</h2>

<h2>[19] gtable_0.2.0       nlme_3.1-128       mgcv_1.8-14</h2>

<h2>[22] quantreg_5.26      DBI_0.5            MatrixModels_0.4-1</h2>

<h2>[25] survival_2.39-5    lme4_1.1-12        lazyeval_0.2.0</h2>

<h2>[28] assertthat_0.1     tibble_1.2         Matrix_1.2-7.1</h2>

<h2>[31] formatR_1.4        nloptr_1.0.4       ggplot2_2.1.0</h2>

<h2>[34] evaluate_0.9       stringi_1.1.1      scales_0.4.0</h2>

<h2>[37] SparseM_1.7        expm_0.999-0       mvtnorm_1.0-5</h2>

<h2>[40] markdown_0.7.7</h2>

<p>Sys.time()## [1] &ldquo;2016-09-03 14:37:31 PDT&rdquo;</p>

</body>

</html>
